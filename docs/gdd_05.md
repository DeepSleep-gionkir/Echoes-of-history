## **[Part 5] 비동기 플레이와 서버 이벤트 (Async & Server Events)**

이 파트는 **"플레이어가 잠든 시간"**과 **"서버의 역사"**를 다룹니다.
직장인 유저가 하루 종일 게임을 켜두지 않아도 불이익을 받지 않게 하고(오프라인 섭정), 고인물들이 서버를 독점하여 지루해지는 것을 막는(글로벌 위기) 시스템입니다.

---

### **5.1. 오프라인 섭정 시스템 (The AI Regent)**

유저가 로그아웃하면 즉시 **[자동 방어 모드]**가 켜집니다.
중요한 건, 섭정 AI는 **비용이 드는 LLM(Gemini)이 아니라, 빠르고 공짜인 '알고리즘(Code)'**이라는 점입니다.

#### **1) 방어 알고리즘 (Reactive Defense Logic)**

유저가 없을 때 섭정은 오직 **수동적(Passive)**으로만 행동합니다.

- **침략 감지:**
  - `if (enemy_unit_entered_territory)` → **즉시 대응.**
  - 가장 가까운 내 군대(`Idle` 상태)를 침략 지점으로 이동시킴 (A\* Pathfinding).
- **외교 수신:**
  - 무역 제안 등이 오면 **[보류(Pending)]** 상태로 저장해둡니다. (멋대로 수락/거절하지 않음).
  - 상대방에게는 자동 응답 메시지 전송: _"국왕께서 부재중이십니다. 안건은 상소문에 올려두겠습니다."_

#### **2) 아침의 브리핑 (The Morning Briefing)**

유저가 다시 로그인했을 때, 밤새 있었던 일을 **AI가 요약**해서 보여줍니다. (여기서 Gemini 사용!)

- **데이터 수집 (Batch):** 밤새 쌓인 시스템 로그(전투 20건, 외교 3건)를 가져옵니다.
- **AI 처리 (1회 호출):**
  - _Input:_ 로그 리스트 23건.
  - _Prompt:_ "이 로그들을 국왕에게 보고하는 신하의 어조로 3줄 요약해."
- **UI 출력 (신문 형태):**
  > **[🌙 지난밤의 연대기]**
  >
  > 1. **[국방]** 북쪽 국경에서 야만족의 침입이 있었으나 제3군단이 격퇴했습니다. (피해 경미)
  > 2. **[외교]** 이웃나라 B가 '철' 무역을 제안했습니다. (결재 대기 중)
  > 3. **[내정]** 가뭄으로 인해 남부 농장의 수확량이 감소했습니다.

---

### **5.2. 글로벌 위기 시스템 (The Chaos Engine)**

서버가 평화로워서 지루해지거나(Stagnation), 특정 연맹이 맵을 다 먹어버리면 **시스템이 판을 흔듭니다.**

#### **1) 혼돈 지수 (Chaos Index)**

서버 전체 공유 변수입니다.

- **상승 요인:** 평화 협정이 많음, 전쟁 없음, 상위 1위 유저의 점수 독주.
- **임계점 돌파:** 혼돈 지수가 **100**을 넘으면 **[글로벌 위기]**가 트리거됩니다.

#### **2) 위기 시나리오 (Procedural Crisis)**

위기가 발동되면 AI가 시나리오의 **'껍데기(Flavor)'**를 만들고, 코드가 **'알맹이(Mechanic)'**를 실행합니다.

- **Step 1. AI 작명 & 설정:**
  - _요청:_ "전염병 위기 이름을 지어줘." -> _AI:_ **"붉은 안개 역병(Red Mist Plague)"**
- **Step 2. 시스템 적용 (Code):**
  - 서버 내 모든 타일의 식량 생산량 -50%.
  - 인구 감소 속도 2배.
- **Step 3. 결과:**
  - 식량이 부족해진 유저들이 살기 위해 서로의 식량 창고를 약탈하기 시작함. (**강제 전쟁 유도**)

---

### **5.3. 역사 아카이브 (Vector Memory & RAG)**

"너 저번에 내 뒤통수 쳤잖아"를 기억하게 만드는 시스템입니다.
DB 비용을 아끼기 위해 **모든 대화를 저장하지 않고 '사건'만 저장**합니다.

#### **1) 기억의 저장 (Embedding)**

- **저장 대상:** 전쟁 선포, 동맹 파기, 대규모 무역 등 **중요 이벤트(Major Event)**만.
- **프로세스:**
  1.  이벤트 발생: `User A declared war on User B`.
  2.  텍스트화: "A가 B에게 전쟁을 선포함."
  3.  벡터 변환: Supabase `pgvector`에 임베딩 저장.

#### **2) 기억의 인출 (RAG - Retrieval Augmented Generation)**

- **상황:** 100년(게임 시간) 뒤, A가 B에게 "동맹 맺자"고 제안.
- **검색:** 시스템이 'A', 'B', '동맹' 키워드로 벡터 DB 검색.
- **발견:** "100년 전 A가 전쟁 선포함" 기록 발견.
- **AI 프롬프트 주입:**
  - _"참고: A는 과거에 B를 침략한 적이 있음."_
- **NPC(B)의 반응:**
  - **"피의 역사를 잊었는가? 감히 동맹을 입에 올리다니!"** (거절)

---

### **5.4. 개발 체크리스트 (To-Do)**

**1) 백엔드 (Node.js + Cron)**

- [ ] **Scheduler:** `node-cron` 설치. 1분마다 오프라인 유저 체크 로직 작성.
- [ ] **Auto-Defense:** `A* 알고리즘` 라이브러리를 사용해 적이 오면 유닛을 이동시키는 간단한 AI 함수 구현.

**2) 데이터베이스 (Supabase)**

- [ ] **Logs Table:** `is_read` 컬럼을 추가하여, 유저가 읽지 않은 로그만 아침 브리핑에 사용하도록 설계.
- [ ] **Vector DB:** Supabase 대시보드에서 `pgvector` 확장 기능 켜기.

**3) 게임 로직**

- [ ] **Chaos Meter:** 서버 메모리에 `globalChaos` 변수 선언. 매 턴마다 변동 로직(평화로우면 +1) 작성.
- [ ] **Crisis Trigger:** 지수가 100이 되면 실행할 `triggerPlague()`, `triggerInvasion()` 같은 재앙 함수 미리 코딩.

---
