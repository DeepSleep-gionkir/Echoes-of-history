**[Part 4. AI 상호작용과 권위 (AI Interaction & Authority)]**에 대한 상세 기획입니다.

이 파트는 **"하이브리드 엔진(Hybrid Engine)"**의 진수가 발휘되는 구간입니다.
플레이어의 행동을 90%의 **코드(규칙)**로 빈틈없이 계산하고, 결정적인 순간에 10%의 **AI(감성)**로 포장하여 유저에게 전달하는 시스템입니다.

---

### **4.1. 결재 시스템 (The Sanction System)**

플레이어가 "왕"으로서의 권력을 체감하게 하는 핵심 UX입니다. 모든 명령은 즉시 실행되지 않고, 참모(시스템)의 **보고(Proposal)**와 왕의 **재가(Sanction)** 과정을 거칩니다.

#### **1) 프로세스 흐름 (Workflow)**

1.  **명령 (Command):** 유저가 `[건설: 대성당]` 버튼 클릭.
2.  **계산 (Calculation - 100% Code):**
    - 기초 비용 확인 (자재 -500, 골드 -200).
    - 상태 변수 확인 (`is_war === true` → 비용 1.5배 할증).
    - 내부 엔티티 반응 시뮬레이션 (사제파 `religious` 태그 확인 → 충성도 ▲10 예상).
3.  **제안 (Proposal - UI 팝업):**
    - 화면 중앙에 **[결재 서류]** 형태의 모달이 뜹니다.
    - AI가 쓴 소설이 아니라, **데이터를 시각화한 UI**입니다.
    - **내용:**
      - 📉 **비용:** 금 300, 자재 500
      - 📈 **예상 효과:** 권위 +50, 사제파 충성도 상승
      - ⚠️ **경고:** "국고가 바닥납니다. 파산 위험!" (조건부 출력)
4.  **재가 (Sanction - User Action):**
    - 유저가 **[옥새 찍기(승인)]** 버튼을 눌러야 자원이 차감되고 실행됩니다.

#### **2) AI의 역할 (Flavor Text Injection)**

- 평소에는 시스템 템플릿("건설 승인 요청")을 사용합니다.
- **특수 상황(권위가 매우 높거나 낮음)**일 때만 Gemini API를 1회 호출하여 결재 서류의 **'코멘트(Remarks)'** 란을 채웁니다.
  - _상황:_ 권위가 바닥인데 대성당 건설 시도.
  - _AI 코멘트:_ **"재상: 전하, 빚쟁이들이 궁궐 문을 두드리는 와중에 신의 집을 짓겠다니요? 미치셨습니까?"**

---

### **4.2. 권위 판정 시스템 (Authority Check System)**

플레이어의 스탯 중 **`권위(Authority)`**는 단순한 마나가 아닙니다. **세계가 나를 대하는 태도(AI 프롬프트의 Context)**를 결정하는 변수입니다.

#### **1) 권위의 3단계 (The 3 Tiers)**

AI에게 프롬프트를 보낼 때, 항상 `current_authority_tier` 정보를 같이 보냅니다.

| 단계               | 범위 (0~100) | AI/NPC의 태도 (System Instruction)               | 외교적 효과                                        |
| :----------------- | :----------- | :----------------------------------------------- | :------------------------------------------------- |
| **무시 (Ignored)** | 0 ~ 30       | "유저를 비웃고, 무시하고, 훈계해라."             | 선전포고를 해도 아무도 겁먹지 않음. (업적: 몽상가) |
| **평범 (Normal)**  | 31 ~ 70      | "비즈니스 파트너로서 정중하게 대하라."           | 표준적인 무역 및 협상 가능.                        |
| **경외 (Revered)** | 71 ~ 100     | "신이나 황제를 대하듯 극존칭을 쓰고 두려워하라." | 말 한마디로 소국을 복속시키거나 조공을 요구 가능.  |

#### **2) 평판 태그 (Reputation Tags)**

플레이어의 과거 행동에 따라 **영구적인 태그**가 붙습니다. 이는 권위와 별개로 AI의 반응을 결정합니다.

- `warmonger` (전쟁광): 평화 협정 시 AI가 의심함. ("피 묻은 손을 씻고 오시오.")
- `deal_breaker` (배신자): 약속을 어긴 적 있음. 무역 시 담보를 요구함.
- `lunatic` (광인): 비논리적인 행동(자원 파기 등) 반복.

**구현 방식 (Node.js):**

```javascript
// AI 요청 시 프롬프트 조립
const prompt = {
  role: "Neighbor_King",
  user_status: {
    authority: "Revered", // 쩔어줌
    reputation: ["warmonger"], // 근데 전쟁광임
  },
  instruction: "두려워하되, 경계를 풀지 않는 태도로 응답하라.",
};
```

---

### **4.3. 뉴럴 외교 (Neural Diplomacy)**

1:1 채팅은 비용이 가장 많이 드는 구간입니다. **[행동력 시스템]**으로 제한하고, **[필터링]**으로 퀄리티를 높입니다.

#### **1) 외교 사절 시스템 (Cost Control)**

- **사절 토큰 (Envoy Token):**
  - 매일 **5개**의 무료 토큰 지급.
  - 채팅 1회 전송 = 토큰 1개 소모.
  - 추가는 유료(BM) 혹은 광고 시청.
- **효과:** 무의미한 도배 방지 및 서버 비용 통제.

#### **2) AI 통역 프로토콜 (The Royal Filter)**

유저가 "야 돈 줘"라고 쳐도, 상대방에게는 격식 있는 문장으로 전달됩니다.

- **Process:**
  1.  **Sender (User A):** "야, 쌀 좀 줘. 안 주면 쳐들어간다." (입력)
  2.  **Server (AI Processing):**
      - 입력 분석: `intent="threat"`, `demand="food"`, `tone="aggressive"`
      - 화자 정보: A는 `Revered`(권위 높음).
      - **재작성 (Gemini 2.5):** _"본 왕이 자비를 베풀 기회를 주겠다. 식량을 내놓아라. 그렇지 않으면 나의 군대가 귀국의 들판을 짓밟을 것이다."_
  3.  **Receiver (User B):** 재작성된 메시지 수신.

#### **3) NPC와의 협상 (JSON Parsing)**

NPC 국가에게 제안할 때는 텍스트가 아닌 **데이터**로 처리합니다.

- 유저가 채팅창에 "동맹 맺자" 입력.
- AI 분석 결과: `{"action": "propose_alliance"}`
- **서버 로직 수행:**
  - `if (User.authority > 70 || User.relation > 50)` -> **성공.**
  - `else` -> **실패.**
- **결과 출력:** AI가 실패 사유를 설명. _"귀관의 권위는 아직 우리와 어깨를 나란히 할 수준이 아닙니다."_

---

### **4.4. 개발 체크리스트 (To-Do)**

**1) 데이터 구조**

- [ ] `authority` 컬럼(User 테이블)의 수치에 따라 3단계(Tier)를 반환하는 헬퍼 함수 작성.
- [ ] `reputation_tags` 배열 컬럼 추가 (User 테이블).

**2) 로직 구현**

- [ ] **Sanction Modal:** 프론트엔드에서 `proposal` JSON을 받으면 뜨는 결재창 컴포넌트 제작. (디자인: 낡은 양피지 느낌)
- [ ] **Envoy System:** 채팅 전송 시 DB에서 `token` 차감하고, 0이면 전송 막는 로직.

**3) AI 연동**

- [ ] **Translation Bot:** 유저의 저렴한 말투를 '중세 왕실 말투'로 변환하는 프롬프트 엔지니어링 테스트.
- [ ] **Context Injection:** AI 호출 시 `authority_tier`와 `tags`를 JSON에 포함시켜 보내는 모듈 작성.

---
